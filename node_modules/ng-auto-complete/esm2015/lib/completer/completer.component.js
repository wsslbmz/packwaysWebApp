/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { debounceTime } from 'rxjs/operators';
import { Component, EventEmitter, Input, NgZone, Output, ViewChild } from '@angular/core';
import { AutocompleteGroup } from '../classes/AutocompleteGroup';
import { ComparableAutoCompleteString, SearchableAutoCompleteString } from '../classes/AutocompleteItem';
import { NgDropdownDirective } from '../dropdown/ng-dropdown.directive';
import { Subject } from 'rxjs';
export class CompleterComponent {
    /**
     * @param {?} _zone
     */
    constructor(_zone) {
        this._zone = _zone;
        this.cleared = new EventEmitter();
        this.selected = new EventEmitter();
        this.noResult = new EventEmitter();
        this.group = (/** @type {?} */ ({}));
        this._change = new Subject();
        this._items = {};
        this._completer = '';
        this._highlight = '';
        this._DOM = {
            notFound: (/** @type {?} */ (false)),
            empty: (/** @type {?} */ (false)),
            placeholder: (/** @type {?} */ (null)),
            selected: (/** @type {?} */ ('')),
            isLoading: (/** @type {?} */ (false))
        };
    }
    /**
     *
     * @return {?}
     */
    ngOnInit() {
        this._zone.runOutsideAngular(() => {
            this._change.pipe(debounceTime(300))
                .subscribe((value) => {
                this._zone.run(() => {
                    if (this.group.async !== null) {
                        this.RunAsyncFunction(value);
                    }
                    else {
                        this.OnModelChange(value);
                    }
                });
            });
        });
        this.SetItems();
    }
    /**
     * Only used when completion is off.
     * @return {?}
     */
    RegisterClick() {
        if (!this.group.completion) {
            this.SwitchDropdownState();
        }
    }
    /**
     *
     * @return {?}
     */
    DropdownArray() {
        if (this.group.completion) {
            this.SwitchDropdownState();
        }
    }
    /**
     *
     * @return {?}
     */
    SwitchDropdownState() {
        if (this.dropdown._open) {
            this.CloseDropdown();
            return;
        }
        /**
         *
         */
        this.OpenDropdown();
    }
    /**
     *
     * @return {?}
     */
    CloseDropdown() {
        this.dropdown._open = false;
        /**
         *
         */
        this._DOM.placeholder = null;
    }
    /**
     *
     * @return {?}
     */
    OpenDropdown() {
        this.dropdown.Open();
        /**
         *
         */
        this._DOM.placeholder = null;
    }
    /**
     *
     * @return {?}
     */
    SetItems() {
        this._items = this.group.value;
        this.IsInitialEmpty();
    }
    /**
     *
     * @param {?} item
     * @return {?}
     */
    SelectItem(item) {
        /** @type {?} */
        let i;
        if (typeof item === 'string') {
            i = this._items[item];
            this._DOM.selected = item;
        }
        else {
            i = item;
            this._DOM.selected = SearchableAutoCompleteString(item.title, item.id);
        }
        this._completer = i.title;
        this._highlight = '';
        this.dropdown.Close(null, true);
        this.selected.emit({ group: { key: this.group.key }, item: i });
    }
    /**
     *
     * @param {?} value
     * @return {?}
     */
    RunAsyncFunction(value) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            this._completer = value;
            this._highlight = value;
            this._DOM.selected = null;
            if (value.length === 0) {
                this.group.InitialValue();
                this.ClearModel();
                this.dropdown.Close('', true);
            }
            else if (value.length > this.group.searchLength) {
                this._DOM.isLoading = true;
                /** @type {?} */
                let values = yield this.group.async(value);
                this.group.SetNewValue(values, this.group.keys.titleKey);
                this._DOM.isLoading = false;
                this._items = this.group.value;
                this.EmptySearch(this._items, value);
                // User has typed something now, results could be shown. We need to remove the "is-initial-empty" class.
                this.IsInitialEmpty();
                this.dropdown.Open();
            }
        });
    }
    /**
     *
     * @param {?} value
     * @return {?}
     */
    OnModelChange(value) {
        this._completer = value;
        this._highlight = value;
        this._DOM.selected = null;
        if (value.length === 0) {
            this.ClearModel();
            this.dropdown.Close('', true);
        }
        else if (value.length > this.group.searchLength) {
            this.CompareItemsAndSet(value);
        }
    }
    /**
     *
     * @return {?}
     */
    ClearModel() {
        this._DOM.selected = null;
        this._DOM.notFound = false;
        this.cleared.emit(this.group.key);
    }
    /**
     *
     * @param {?} value
     * @return {?}
     */
    CompareItemsAndSet(value) {
        /** @type {?} */
        const obj = {};
        for (let key in this.group.value) {
            if (ComparableAutoCompleteString(key).toLowerCase().indexOf(value.toLowerCase()) > -1) {
                obj[key] = this.group.value[key];
            }
        }
        this._items = obj;
        this.EmptySearch(this._items, value);
        // User has typed something now, results could be shown. We need to remove the "is-initial-empty" class.
        this.IsInitialEmpty();
        this.dropdown.Open();
    }
    /**
     *
     * @return {?}
     */
    OnInputBlurred() {
        if (!this.HasChosenValue()) {
            /**
             * Let component know completer input has been cleared -
             * this function shows the list again, also resets children, if chosen.
             */
            this.OnModelChange('');
        }
    }
    /**
     *
     * @param {?} item
     * @return {?}
     */
    OnHoverDropdownItem(item) {
        if (typeof item == 'string') {
            this._DOM.placeholder = this._items[item];
            return;
        }
        if (item == null) {
            this._DOM.placeholder = null;
            return;
        }
        this._DOM.placeholder = item;
    }
    // =======================================================================//
    // ! Utils                                                                //
    // =======================================================================//
    /**
     * @return {?}
     */
    IsInitialEmpty() {
        if (Object.keys(this._items).length === 0 && this._completer.length === 0) {
            this._DOM.empty = true;
            return;
        }
        this._DOM.empty = false;
    }
    /**
     *
     * @return {?}
     */
    HasChosenValue() {
        return this._DOM.selected !== null;
    }
    /**
     *
     * @param {?} obj
     * @param {?} query
     * @return {?}
     */
    EmptySearch(obj, query) {
        if (Object.keys(obj).length > 0) {
            this._DOM.notFound = false;
            return;
        }
        this._DOM.notFound = true;
        this.noResult.emit({ group: { key: this.group.key }, query: query });
    }
    /**
     *
     * @return {?}
     */
    ClearValue() {
        this._completer = '';
        this._DOM.selected = null;
        this.group.InitialValue();
        this.IsInitialEmpty();
        /**
         *
         */
        this.selected.emit({ group: { key: this.group.key }, item: null });
    }
}
CompleterComponent.decorators = [
    { type: Component, args: [{
                selector: 'ng-completer',
                template: `
        <div #element class="ng-autocomplete-dropdown"
             [ngClass]="{'open': dropdown._open, 'is-loading': _DOM.isLoading, 'is-async': group.async !== null}">

            <!--GROUP: {{group.key}}-->

            <div class="ng-autocomplete-inputs" (click)="RegisterClick()"
                 [ngClass]="{'completion-off': !group.completion}">
                <span class="ng-autocomplete-placeholder"
                      *ngIf="_DOM.placeholder">
                  <ng-container *ngIf="group.placeholderValue">
                      <ng-template *ngTemplateOutlet="group.placeholderValue; context: {$implicit: _DOM.placeholder}"></ng-template>
                  </ng-container>
                  <ng-template [ngIf]="!group.placeholderValue">
                      {{_DOM.placeholder.title}}
                  </ng-template>
                </span>
                <input #input type="text" [placeholder]="group.placeholder" name="completer" [(ngModel)]="_completer"
                       (ngModelChange)="_change.next($event);"
                       [value]="_completer"
                       autocomplete="off"
                       (click)="OpenDropdown()"
                       (focus)="OpenDropdown()" class="ng-autocomplete-input">

                <span [ngClass]="{'open': dropdown._open}" class="ng-autocomplete-dropdown-icon"
                      (click)="DropdownArray()"></span>
            </div>

            <div class="ng-dropdown" ngDropdown [list]="_items" [element]="element" [input]="input"
                 [ngClass]="{'is-initial-empty': _DOM.empty}"
                 [active]="_DOM.selected" [key]="group.key"
                 [completion]="group.completion"
                 (hover)="OnHoverDropdownItem($event)"
                 (selected)="SelectItem($event)"
                 (closed)="OnInputBlurred()"
            >
                <div *ngIf="_DOM.notFound && group.noResults" class="dropdown-item no-results">
                    <ng-container *ngIf="group.noResults">
                        <ng-template *ngTemplateOutlet="group.noResults; context: {$implicit: _completer}"></ng-template>
                    </ng-container>
                </div>

                <div class="dropdown-item" *ngFor="let item of _items | keys; let i = index"
                     (click)="SelectItem(_items[item])">

                    <ng-container *ngIf="group.dropdownValue">
                        <ng-template
                            *ngTemplateOutlet="group.dropdownValue; context: {$implicit: _items[item], highlight: _items[item].title | highlight:_highlight}"></ng-template>
                    </ng-container>

                    <div *ngIf="!group.dropdownValue" [innerHTML]="_items[item].title | highlight:_highlight"></div>
                </div>
            </div>
        </div>`,
                styles: [`
        .ng-autocomplete-inputs {
            position: relative;
        }

        .ng-autocomplete-inputs.completion-off {
            cursor: pointer;
        }

        .ng-autocomplete-inputs.completion-off input {
            pointer-events: none;
        }

        .ng-autocomplete-placeholder {
            pointer-events: none;
        }

        .ng-autocomplete-dropdown-icon {

        }

        .ng-autocomplete-dropdown .ng-dropdown {
            display: none;
        }

        .ng-autocomplete-dropdown .ng-dropdown.is-empty {
            display: none;
        }

        .ng-autocomplete-dropdown .ng-dropdown.open {
            display: block;
        }
    `]
            }] }
];
/** @nocollapse */
CompleterComponent.ctorParameters = () => [
    { type: NgZone }
];
CompleterComponent.propDecorators = {
    dropdown: [{ type: ViewChild, args: [NgDropdownDirective,] }],
    cleared: [{ type: Output }],
    selected: [{ type: Output }],
    noResult: [{ type: Output, args: ['no-result',] }],
    group: [{ type: Input }]
};
if (false) {
    /** @type {?} */
    CompleterComponent.prototype.dropdown;
    /** @type {?} */
    CompleterComponent.prototype.cleared;
    /** @type {?} */
    CompleterComponent.prototype.selected;
    /** @type {?} */
    CompleterComponent.prototype.noResult;
    /** @type {?} */
    CompleterComponent.prototype.group;
    /** @type {?} */
    CompleterComponent.prototype._change;
    /** @type {?} */
    CompleterComponent.prototype._items;
    /** @type {?} */
    CompleterComponent.prototype._completer;
    /** @type {?} */
    CompleterComponent.prototype._highlight;
    /** @type {?} */
    CompleterComponent.prototype._DOM;
    /**
     * @type {?}
     * @private
     */
    CompleterComponent.prototype._zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tcGxldGVyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nLWF1dG8tY29tcGxldGUvIiwic291cmNlcyI6WyJsaWIvY29tcGxldGVyL2NvbXBsZXRlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBVSxNQUFNLEVBQUUsU0FBUyxFQUFDLE1BQU0sZUFBZSxDQUFDO0FBQ2hHLE9BQU8sRUFBQyxpQkFBaUIsRUFBQyxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFFSCw0QkFBNEIsRUFDNUIsNEJBQTRCLEVBRS9CLE1BQU0sNkJBQTZCLENBQUM7QUFDckMsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sbUNBQW1DLENBQUM7QUFFdEUsT0FBTyxFQUFDLE9BQU8sRUFBQyxNQUFNLE1BQU0sQ0FBQztBQTRGN0IsTUFBTSxPQUFPLGtCQUFrQjs7OztJQXVCM0IsWUFBb0IsS0FBYTtRQUFiLFVBQUssR0FBTCxLQUFLLENBQVE7UUFwQmhCLFlBQU8sR0FBeUIsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUMzRCxhQUFRLEdBQTRDLElBQUksWUFBWSxFQUE2QixDQUFDO1FBQ3ZGLGFBQVEsR0FBZ0MsSUFBSSxZQUFZLEVBQWlCLENBQUM7UUFFdEYsVUFBSyxHQUFzQixtQkFBbUIsRUFBRSxFQUFBLENBQUM7UUFFakUsWUFBTyxHQUFvQixJQUFJLE9BQU8sRUFBVSxDQUFDO1FBQ2pELFdBQU0sR0FBMEMsRUFBRSxDQUFDO1FBQ25ELGVBQVUsR0FBVyxFQUFFLENBQUM7UUFDeEIsZUFBVSxHQUFXLEVBQUUsQ0FBQztRQUV4QixTQUFJLEdBQUc7WUFDSCxRQUFRLEVBQUUsbUJBQVMsS0FBSyxFQUFBO1lBQ3hCLEtBQUssRUFBRSxtQkFBUyxLQUFLLEVBQUE7WUFDckIsV0FBVyxFQUFFLG1CQUFrQixJQUFJLEVBQUE7WUFDbkMsUUFBUSxFQUFFLG1CQUFRLEVBQUUsRUFBQTtZQUNwQixTQUFTLEVBQUUsbUJBQVMsS0FBSyxFQUFBO1NBRTVCLENBQUM7SUFHRixDQUFDOzs7OztJQUtELFFBQVE7UUFDSixJQUFJLENBQUMsS0FBSyxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRTtZQUU5QixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FDYixZQUFZLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2pCLFNBQVMsQ0FBQyxDQUFDLEtBQWEsRUFBRSxFQUFFO2dCQUN6QixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUU7b0JBQ2hCLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEtBQUssSUFBSSxFQUFFO3dCQUMzQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7cUJBQ2hDO3lCQUFNO3dCQUNILElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7cUJBQzVCO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNwQixDQUFDOzs7OztJQUtELGFBQWE7UUFDVCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUU7WUFDeEIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUE7U0FDN0I7SUFDTCxDQUFDOzs7OztJQUtELGFBQWE7UUFDVCxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ3ZCLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO1NBQzdCO0lBQ0wsQ0FBQzs7Ozs7SUFLRCxtQkFBbUI7UUFDZixJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFO1lBQ3JCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUNyQixPQUFPO1NBQ1Y7UUFFRDs7V0FFRztRQUNILElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQTtJQUN2QixDQUFDOzs7OztJQUtELGFBQWE7UUFDVCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFNUI7O1dBRUc7UUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUM7SUFDakMsQ0FBQzs7Ozs7SUFLRCxZQUFZO1FBQ1IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUVyQjs7V0FFRztRQUNILElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztJQUNqQyxDQUFDOzs7OztJQUtELFFBQVE7UUFDSixJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDO1FBQy9CLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUMxQixDQUFDOzs7Ozs7SUFLRCxVQUFVLENBQUMsSUFBK0I7O1lBQ2xDLENBQW1CO1FBQ3ZCLElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFO1lBQzFCLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztTQUM3QjthQUFNO1lBQ0gsQ0FBQyxHQUFHLElBQUksQ0FBQztZQUNULElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLDRCQUE0QixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1NBQzFFO1FBRUQsSUFBSSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQzFCLElBQUksQ0FBQyxVQUFVLEdBQUcsRUFBRSxDQUFDO1FBRXJCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNoQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBRSxFQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUMsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7Ozs7OztJQUtLLGdCQUFnQixDQUFDLEtBQWE7O1lBQ2hDLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1lBRXhCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztZQUUxQixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO2dCQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUMxQixJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7Z0JBRWxCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsQ0FBQTthQUNoQztpQkFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUU7Z0JBQy9DLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQzs7b0JBRXZCLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQztnQkFDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUV6RCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxLQUFLLENBQUM7Z0JBRTVCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUM7Z0JBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFFckMsd0dBQXdHO2dCQUN4RyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3RCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7YUFDeEI7UUFDTCxDQUFDO0tBQUE7Ozs7OztJQUtELGFBQWEsQ0FBQyxLQUFhO1FBQ3ZCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ3hCLElBQUksQ0FBQyxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBRXhCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQztRQUUxQixJQUFJLEtBQUssQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQ3BCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUVsQixJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLENBQUE7U0FDaEM7YUFBTSxJQUFJLEtBQUssQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUU7WUFDL0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2xDO0lBQ0wsQ0FBQzs7Ozs7SUFLRCxVQUFVO1FBQ04sSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQzFCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUUzQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3RDLENBQUM7Ozs7OztJQUtELGtCQUFrQixDQUFDLEtBQWE7O2NBQ3RCLEdBQUcsR0FBRyxFQUFFO1FBQ2QsS0FBSyxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRTtZQUM5QixJQUFJLDRCQUE0QixDQUFDLEdBQUcsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRTtnQkFDbkYsR0FBRyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFBO2FBQ25DO1NBQ0o7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQztRQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFFckMsd0dBQXdHO1FBQ3hHLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ3pCLENBQUM7Ozs7O0lBS0QsY0FBYztRQUNWLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUU7WUFDeEI7OztlQUdHO1lBQ0gsSUFBSSxDQUFDLGFBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUMxQjtJQUNMLENBQUM7Ozs7OztJQUtELG1CQUFtQixDQUFDLElBQStCO1FBQy9DLElBQUksT0FBTyxJQUFJLElBQUksUUFBUSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDMUMsT0FBTztTQUNWO1FBQ0QsSUFBSSxJQUFJLElBQUksSUFBSSxFQUFFO1lBQ2QsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1lBQzdCLE9BQU87U0FDVjtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztJQUNqQyxDQUFDOzs7Ozs7O0lBTUQsY0FBYztRQUNWLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsTUFBTSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDdkUsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDO1lBQ3ZCLE9BQU87U0FDVjtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUM1QixDQUFDOzs7OztJQUtELGNBQWM7UUFDVixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxLQUFLLElBQUksQ0FBQTtJQUN0QyxDQUFDOzs7Ozs7O0lBS0QsV0FBVyxDQUFDLEdBQVcsRUFBRSxLQUFhO1FBQ2xDLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztZQUMzQixPQUFNO1NBQ1Q7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFDMUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBQyxLQUFLLEVBQUUsRUFBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUMsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFDLENBQUMsQ0FBQTtJQUNwRSxDQUFDOzs7OztJQUtELFVBQVU7UUFDTixJQUFJLENBQUMsVUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUM7UUFFMUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDdEI7O1dBRUc7UUFDSCxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFDLEtBQUssRUFBRSxFQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBQyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUMsQ0FBQyxDQUFDO0lBQ25FLENBQUM7OztZQXhYSixTQUFTLFNBQUM7Z0JBQ1AsUUFBUSxFQUFFLGNBQWM7Z0JBQ3hCLFFBQVEsRUFBRTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7ZUFxREM7eUJBQ0Y7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0tBZ0NSO2FBQ0o7Ozs7WUFyR3VDLE1BQU07Ozt1QkF1R3pDLFNBQVMsU0FBQyxtQkFBbUI7c0JBRTdCLE1BQU07dUJBQ04sTUFBTTt1QkFDTixNQUFNLFNBQUMsV0FBVztvQkFFbEIsS0FBSzs7OztJQU5OLHNDQUFxRTs7SUFFckUscUNBQTRFOztJQUM1RSxzQ0FBbUg7O0lBQ25ILHNDQUFzRzs7SUFFdEcsbUNBQWlFOztJQUVqRSxxQ0FBaUQ7O0lBQ2pELG9DQUFtRDs7SUFDbkQsd0NBQXdCOztJQUN4Qix3Q0FBd0I7O0lBRXhCLGtDQU9FOzs7OztJQUVVLG1DQUFxQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7ZGVib3VuY2VUaW1lfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQge0NvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgTmdab25lLCBPbkluaXQsIE91dHB1dCwgVmlld0NoaWxkfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7QXV0b2NvbXBsZXRlR3JvdXB9IGZyb20gJy4uL2NsYXNzZXMvQXV0b2NvbXBsZXRlR3JvdXAnO1xuaW1wb3J0IHtcbiAgICBBdXRvY29tcGxldGVJdGVtLFxuICAgIENvbXBhcmFibGVBdXRvQ29tcGxldGVTdHJpbmcsXG4gICAgU2VhcmNoYWJsZUF1dG9Db21wbGV0ZVN0cmluZyxcbiAgICBTdHJpcHBlZEF1dG9jb21wbGV0ZUdyb3VwXG59IGZyb20gJy4uL2NsYXNzZXMvQXV0b2NvbXBsZXRlSXRlbSc7XG5pbXBvcnQge05nRHJvcGRvd25EaXJlY3RpdmV9IGZyb20gJy4uL2Ryb3Bkb3duL25nLWRyb3Bkb3duLmRpcmVjdGl2ZSc7XG5pbXBvcnQge0dyb3VwTm9SZXN1bHR9IGZyb20gJy4uL3V0aWxzL3V0aWxzJztcbmltcG9ydCB7U3ViamVjdH0gZnJvbSAncnhqcyc7XG5cbkBDb21wb25lbnQoe1xuICAgIHNlbGVjdG9yOiAnbmctY29tcGxldGVyJyxcbiAgICB0ZW1wbGF0ZTogYFxuICAgICAgICA8ZGl2ICNlbGVtZW50IGNsYXNzPVwibmctYXV0b2NvbXBsZXRlLWRyb3Bkb3duXCJcbiAgICAgICAgICAgICBbbmdDbGFzc109XCJ7J29wZW4nOiBkcm9wZG93bi5fb3BlbiwgJ2lzLWxvYWRpbmcnOiBfRE9NLmlzTG9hZGluZywgJ2lzLWFzeW5jJzogZ3JvdXAuYXN5bmMgIT09IG51bGx9XCI+XG5cbiAgICAgICAgICAgIDwhLS1HUk9VUDoge3tncm91cC5rZXl9fS0tPlxuXG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwibmctYXV0b2NvbXBsZXRlLWlucHV0c1wiIChjbGljayk9XCJSZWdpc3RlckNsaWNrKClcIlxuICAgICAgICAgICAgICAgICBbbmdDbGFzc109XCJ7J2NvbXBsZXRpb24tb2ZmJzogIWdyb3VwLmNvbXBsZXRpb259XCI+XG4gICAgICAgICAgICAgICAgPHNwYW4gY2xhc3M9XCJuZy1hdXRvY29tcGxldGUtcGxhY2Vob2xkZXJcIlxuICAgICAgICAgICAgICAgICAgICAgICpuZ0lmPVwiX0RPTS5wbGFjZWhvbGRlclwiPlxuICAgICAgICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cImdyb3VwLnBsYWNlaG9sZGVyVmFsdWVcIj5cbiAgICAgICAgICAgICAgICAgICAgICA8bmctdGVtcGxhdGUgKm5nVGVtcGxhdGVPdXRsZXQ9XCJncm91cC5wbGFjZWhvbGRlclZhbHVlOyBjb250ZXh0OiB7JGltcGxpY2l0OiBfRE9NLnBsYWNlaG9sZGVyfVwiPjwvbmctdGVtcGxhdGU+XG4gICAgICAgICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgICAgICAgICAgICAgIDxuZy10ZW1wbGF0ZSBbbmdJZl09XCIhZ3JvdXAucGxhY2Vob2xkZXJWYWx1ZVwiPlxuICAgICAgICAgICAgICAgICAgICAgIHt7X0RPTS5wbGFjZWhvbGRlci50aXRsZX19XG4gICAgICAgICAgICAgICAgICA8L25nLXRlbXBsYXRlPlxuICAgICAgICAgICAgICAgIDwvc3Bhbj5cbiAgICAgICAgICAgICAgICA8aW5wdXQgI2lucHV0IHR5cGU9XCJ0ZXh0XCIgW3BsYWNlaG9sZGVyXT1cImdyb3VwLnBsYWNlaG9sZGVyXCIgbmFtZT1cImNvbXBsZXRlclwiIFsobmdNb2RlbCldPVwiX2NvbXBsZXRlclwiXG4gICAgICAgICAgICAgICAgICAgICAgIChuZ01vZGVsQ2hhbmdlKT1cIl9jaGFuZ2UubmV4dCgkZXZlbnQpO1wiXG4gICAgICAgICAgICAgICAgICAgICAgIFt2YWx1ZV09XCJfY29tcGxldGVyXCJcbiAgICAgICAgICAgICAgICAgICAgICAgYXV0b2NvbXBsZXRlPVwib2ZmXCJcbiAgICAgICAgICAgICAgICAgICAgICAgKGNsaWNrKT1cIk9wZW5Ecm9wZG93bigpXCJcbiAgICAgICAgICAgICAgICAgICAgICAgKGZvY3VzKT1cIk9wZW5Ecm9wZG93bigpXCIgY2xhc3M9XCJuZy1hdXRvY29tcGxldGUtaW5wdXRcIj5cblxuICAgICAgICAgICAgICAgIDxzcGFuIFtuZ0NsYXNzXT1cInsnb3Blbic6IGRyb3Bkb3duLl9vcGVufVwiIGNsYXNzPVwibmctYXV0b2NvbXBsZXRlLWRyb3Bkb3duLWljb25cIlxuICAgICAgICAgICAgICAgICAgICAgIChjbGljayk9XCJEcm9wZG93bkFycmF5KClcIj48L3NwYW4+XG4gICAgICAgICAgICA8L2Rpdj5cblxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cIm5nLWRyb3Bkb3duXCIgbmdEcm9wZG93biBbbGlzdF09XCJfaXRlbXNcIiBbZWxlbWVudF09XCJlbGVtZW50XCIgW2lucHV0XT1cImlucHV0XCJcbiAgICAgICAgICAgICAgICAgW25nQ2xhc3NdPVwieydpcy1pbml0aWFsLWVtcHR5JzogX0RPTS5lbXB0eX1cIlxuICAgICAgICAgICAgICAgICBbYWN0aXZlXT1cIl9ET00uc2VsZWN0ZWRcIiBba2V5XT1cImdyb3VwLmtleVwiXG4gICAgICAgICAgICAgICAgIFtjb21wbGV0aW9uXT1cImdyb3VwLmNvbXBsZXRpb25cIlxuICAgICAgICAgICAgICAgICAoaG92ZXIpPVwiT25Ib3ZlckRyb3Bkb3duSXRlbSgkZXZlbnQpXCJcbiAgICAgICAgICAgICAgICAgKHNlbGVjdGVkKT1cIlNlbGVjdEl0ZW0oJGV2ZW50KVwiXG4gICAgICAgICAgICAgICAgIChjbG9zZWQpPVwiT25JbnB1dEJsdXJyZWQoKVwiXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgICAgPGRpdiAqbmdJZj1cIl9ET00ubm90Rm91bmQgJiYgZ3JvdXAubm9SZXN1bHRzXCIgY2xhc3M9XCJkcm9wZG93bi1pdGVtIG5vLXJlc3VsdHNcIj5cbiAgICAgICAgICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cImdyb3VwLm5vUmVzdWx0c1wiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPG5nLXRlbXBsYXRlICpuZ1RlbXBsYXRlT3V0bGV0PVwiZ3JvdXAubm9SZXN1bHRzOyBjb250ZXh0OiB7JGltcGxpY2l0OiBfY29tcGxldGVyfVwiPjwvbmctdGVtcGxhdGU+XG4gICAgICAgICAgICAgICAgICAgIDwvbmctY29udGFpbmVyPlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuXG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cImRyb3Bkb3duLWl0ZW1cIiAqbmdGb3I9XCJsZXQgaXRlbSBvZiBfaXRlbXMgfCBrZXlzOyBsZXQgaSA9IGluZGV4XCJcbiAgICAgICAgICAgICAgICAgICAgIChjbGljayk9XCJTZWxlY3RJdGVtKF9pdGVtc1tpdGVtXSlcIj5cblxuICAgICAgICAgICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwiZ3JvdXAuZHJvcGRvd25WYWx1ZVwiPlxuICAgICAgICAgICAgICAgICAgICAgICAgPG5nLXRlbXBsYXRlXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKm5nVGVtcGxhdGVPdXRsZXQ9XCJncm91cC5kcm9wZG93blZhbHVlOyBjb250ZXh0OiB7JGltcGxpY2l0OiBfaXRlbXNbaXRlbV0sIGhpZ2hsaWdodDogX2l0ZW1zW2l0ZW1dLnRpdGxlIHwgaGlnaGxpZ2h0Ol9oaWdobGlnaHR9XCI+PC9uZy10ZW1wbGF0ZT5cbiAgICAgICAgICAgICAgICAgICAgPC9uZy1jb250YWluZXI+XG5cbiAgICAgICAgICAgICAgICAgICAgPGRpdiAqbmdJZj1cIiFncm91cC5kcm9wZG93blZhbHVlXCIgW2lubmVySFRNTF09XCJfaXRlbXNbaXRlbV0udGl0bGUgfCBoaWdobGlnaHQ6X2hpZ2hsaWdodFwiPjwvZGl2PlxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgPC9kaXY+XG4gICAgICAgIDwvZGl2PmAsXG4gICAgc3R5bGVzOiBbYFxuICAgICAgICAubmctYXV0b2NvbXBsZXRlLWlucHV0cyB7XG4gICAgICAgICAgICBwb3NpdGlvbjogcmVsYXRpdmU7XG4gICAgICAgIH1cblxuICAgICAgICAubmctYXV0b2NvbXBsZXRlLWlucHV0cy5jb21wbGV0aW9uLW9mZiB7XG4gICAgICAgICAgICBjdXJzb3I6IHBvaW50ZXI7XG4gICAgICAgIH1cblxuICAgICAgICAubmctYXV0b2NvbXBsZXRlLWlucHV0cy5jb21wbGV0aW9uLW9mZiBpbnB1dCB7XG4gICAgICAgICAgICBwb2ludGVyLWV2ZW50czogbm9uZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC5uZy1hdXRvY29tcGxldGUtcGxhY2Vob2xkZXIge1xuICAgICAgICAgICAgcG9pbnRlci1ldmVudHM6IG5vbmU7XG4gICAgICAgIH1cblxuICAgICAgICAubmctYXV0b2NvbXBsZXRlLWRyb3Bkb3duLWljb24ge1xuXG4gICAgICAgIH1cblxuICAgICAgICAubmctYXV0b2NvbXBsZXRlLWRyb3Bkb3duIC5uZy1kcm9wZG93biB7XG4gICAgICAgICAgICBkaXNwbGF5OiBub25lO1xuICAgICAgICB9XG5cbiAgICAgICAgLm5nLWF1dG9jb21wbGV0ZS1kcm9wZG93biAubmctZHJvcGRvd24uaXMtZW1wdHkge1xuICAgICAgICAgICAgZGlzcGxheTogbm9uZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC5uZy1hdXRvY29tcGxldGUtZHJvcGRvd24gLm5nLWRyb3Bkb3duLm9wZW4ge1xuICAgICAgICAgICAgZGlzcGxheTogYmxvY2s7XG4gICAgICAgIH1cbiAgICBgXVxufSlcbmV4cG9ydCBjbGFzcyBDb21wbGV0ZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQge1xuICAgIEBWaWV3Q2hpbGQoTmdEcm9wZG93bkRpcmVjdGl2ZSkgcHVibGljIGRyb3Bkb3duOiBOZ0Ryb3Bkb3duRGlyZWN0aXZlO1xuXG4gICAgQE91dHB1dCgpIHB1YmxpYyBjbGVhcmVkOiBFdmVudEVtaXR0ZXI8c3RyaW5nPiA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuICAgIEBPdXRwdXQoKSBwdWJsaWMgc2VsZWN0ZWQ6IEV2ZW50RW1pdHRlcjxTdHJpcHBlZEF1dG9jb21wbGV0ZUdyb3VwPiA9IG5ldyBFdmVudEVtaXR0ZXI8U3RyaXBwZWRBdXRvY29tcGxldGVHcm91cD4oKTtcbiAgICBAT3V0cHV0KCduby1yZXN1bHQnKSBwdWJsaWMgbm9SZXN1bHQ6IEV2ZW50RW1pdHRlcjxHcm91cE5vUmVzdWx0PiA9IG5ldyBFdmVudEVtaXR0ZXI8R3JvdXBOb1Jlc3VsdD4oKTtcblxuICAgIEBJbnB1dCgpIHB1YmxpYyBncm91cDogQXV0b2NvbXBsZXRlR3JvdXAgPSA8QXV0b2NvbXBsZXRlR3JvdXA+e307XG5cbiAgICBfY2hhbmdlOiBTdWJqZWN0PHN0cmluZz4gPSBuZXcgU3ViamVjdDxzdHJpbmc+KCk7XG4gICAgX2l0ZW1zOiB7IFt2YWx1ZTogc3RyaW5nXTogQXV0b2NvbXBsZXRlSXRlbSB9ID0ge307XG4gICAgX2NvbXBsZXRlcjogc3RyaW5nID0gJyc7XG4gICAgX2hpZ2hsaWdodDogc3RyaW5nID0gJyc7XG5cbiAgICBfRE9NID0ge1xuICAgICAgICBub3RGb3VuZDogPGJvb2xlYW4+ZmFsc2UsXG4gICAgICAgIGVtcHR5OiA8Ym9vbGVhbj5mYWxzZSxcbiAgICAgICAgcGxhY2Vob2xkZXI6IDxBdXRvY29tcGxldGVJdGVtPm51bGwsXG4gICAgICAgIHNlbGVjdGVkOiA8c3RyaW5nPicnLFxuICAgICAgICBpc0xvYWRpbmc6IDxib29sZWFuPmZhbHNlXG5cbiAgICB9O1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBfem9uZTogTmdab25lKSB7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5fem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG5cbiAgICAgICAgICAgIHRoaXMuX2NoYW5nZS5waXBlKFxuICAgICAgICAgICAgICAgIGRlYm91bmNlVGltZSgzMDApKVxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKHZhbHVlOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuZ3JvdXAuYXN5bmMgIT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLlJ1bkFzeW5jRnVuY3Rpb24odmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLk9uTW9kZWxDaGFuZ2UodmFsdWUpXG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLlNldEl0ZW1zKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogT25seSB1c2VkIHdoZW4gY29tcGxldGlvbiBpcyBvZmYuXG4gICAgICovXG4gICAgUmVnaXN0ZXJDbGljaygpIHtcbiAgICAgICAgaWYgKCF0aGlzLmdyb3VwLmNvbXBsZXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuU3dpdGNoRHJvcGRvd25TdGF0ZSgpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIERyb3Bkb3duQXJyYXkoKSB7XG4gICAgICAgIGlmICh0aGlzLmdyb3VwLmNvbXBsZXRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuU3dpdGNoRHJvcGRvd25TdGF0ZSgpXG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIFN3aXRjaERyb3Bkb3duU3RhdGUoKSB7XG4gICAgICAgIGlmICh0aGlzLmRyb3Bkb3duLl9vcGVuKSB7XG4gICAgICAgICAgICB0aGlzLkNsb3NlRHJvcGRvd24oKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKlxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5PcGVuRHJvcGRvd24oKVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgQ2xvc2VEcm9wZG93bigpIHtcbiAgICAgICAgdGhpcy5kcm9wZG93bi5fb3BlbiA9IGZhbHNlO1xuXG4gICAgICAgIC8qKlxuICAgICAgICAgKlxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5fRE9NLnBsYWNlaG9sZGVyID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIE9wZW5Ecm9wZG93bigpIHtcbiAgICAgICAgdGhpcy5kcm9wZG93bi5PcGVuKCk7XG5cbiAgICAgICAgLyoqXG4gICAgICAgICAqXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLl9ET00ucGxhY2Vob2xkZXIgPSBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgU2V0SXRlbXMoKSB7XG4gICAgICAgIHRoaXMuX2l0ZW1zID0gdGhpcy5ncm91cC52YWx1ZTtcbiAgICAgICAgdGhpcy5Jc0luaXRpYWxFbXB0eSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgU2VsZWN0SXRlbShpdGVtOiBBdXRvY29tcGxldGVJdGVtIHwgc3RyaW5nKSB7XG4gICAgICAgIGxldCBpOiBBdXRvY29tcGxldGVJdGVtO1xuICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBpID0gdGhpcy5faXRlbXNbaXRlbV07XG4gICAgICAgICAgICB0aGlzLl9ET00uc2VsZWN0ZWQgPSBpdGVtO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaSA9IGl0ZW07XG4gICAgICAgICAgICB0aGlzLl9ET00uc2VsZWN0ZWQgPSBTZWFyY2hhYmxlQXV0b0NvbXBsZXRlU3RyaW5nKGl0ZW0udGl0bGUsIGl0ZW0uaWQpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5fY29tcGxldGVyID0gaS50aXRsZTtcbiAgICAgICAgdGhpcy5faGlnaGxpZ2h0ID0gJyc7XG5cbiAgICAgICAgdGhpcy5kcm9wZG93bi5DbG9zZShudWxsLCB0cnVlKTtcbiAgICAgICAgdGhpcy5zZWxlY3RlZC5lbWl0KHtncm91cDoge2tleTogdGhpcy5ncm91cC5rZXl9LCBpdGVtOiBpfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBhc3luYyBSdW5Bc3luY0Z1bmN0aW9uKHZhbHVlOiBzdHJpbmcpIHtcbiAgICAgICAgdGhpcy5fY29tcGxldGVyID0gdmFsdWU7XG4gICAgICAgIHRoaXMuX2hpZ2hsaWdodCA9IHZhbHVlO1xuXG4gICAgICAgIHRoaXMuX0RPTS5zZWxlY3RlZCA9IG51bGw7XG5cbiAgICAgICAgaWYgKHZhbHVlLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5ncm91cC5Jbml0aWFsVmFsdWUoKTtcbiAgICAgICAgICAgIHRoaXMuQ2xlYXJNb2RlbCgpO1xuXG4gICAgICAgICAgICB0aGlzLmRyb3Bkb3duLkNsb3NlKCcnLCB0cnVlKVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmxlbmd0aCA+IHRoaXMuZ3JvdXAuc2VhcmNoTGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLl9ET00uaXNMb2FkaW5nID0gdHJ1ZTtcblxuICAgICAgICAgICAgbGV0IHZhbHVlcyA9IGF3YWl0IHRoaXMuZ3JvdXAuYXN5bmModmFsdWUpO1xuICAgICAgICAgICAgdGhpcy5ncm91cC5TZXROZXdWYWx1ZSh2YWx1ZXMsIHRoaXMuZ3JvdXAua2V5cy50aXRsZUtleSk7XG5cbiAgICAgICAgICAgIHRoaXMuX0RPTS5pc0xvYWRpbmcgPSBmYWxzZTtcblxuICAgICAgICAgICAgdGhpcy5faXRlbXMgPSB0aGlzLmdyb3VwLnZhbHVlO1xuICAgICAgICAgICAgdGhpcy5FbXB0eVNlYXJjaCh0aGlzLl9pdGVtcywgdmFsdWUpO1xuXG4gICAgICAgICAgICAvLyBVc2VyIGhhcyB0eXBlZCBzb21ldGhpbmcgbm93LCByZXN1bHRzIGNvdWxkIGJlIHNob3duLiBXZSBuZWVkIHRvIHJlbW92ZSB0aGUgXCJpcy1pbml0aWFsLWVtcHR5XCIgY2xhc3MuXG4gICAgICAgICAgICB0aGlzLklzSW5pdGlhbEVtcHR5KCk7XG4gICAgICAgICAgICB0aGlzLmRyb3Bkb3duLk9wZW4oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgT25Nb2RlbENoYW5nZSh2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuX2NvbXBsZXRlciA9IHZhbHVlO1xuICAgICAgICB0aGlzLl9oaWdobGlnaHQgPSB2YWx1ZTtcblxuICAgICAgICB0aGlzLl9ET00uc2VsZWN0ZWQgPSBudWxsO1xuXG4gICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMuQ2xlYXJNb2RlbCgpO1xuXG4gICAgICAgICAgICB0aGlzLmRyb3Bkb3duLkNsb3NlKCcnLCB0cnVlKVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLmxlbmd0aCA+IHRoaXMuZ3JvdXAuc2VhcmNoTGVuZ3RoKSB7XG4gICAgICAgICAgICB0aGlzLkNvbXBhcmVJdGVtc0FuZFNldCh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIENsZWFyTW9kZWwoKSB7XG4gICAgICAgIHRoaXMuX0RPTS5zZWxlY3RlZCA9IG51bGw7XG4gICAgICAgIHRoaXMuX0RPTS5ub3RGb3VuZCA9IGZhbHNlO1xuXG4gICAgICAgIHRoaXMuY2xlYXJlZC5lbWl0KHRoaXMuZ3JvdXAua2V5KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIENvbXBhcmVJdGVtc0FuZFNldCh2YWx1ZTogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IG9iaiA9IHt9O1xuICAgICAgICBmb3IgKGxldCBrZXkgaW4gdGhpcy5ncm91cC52YWx1ZSkge1xuICAgICAgICAgICAgaWYgKENvbXBhcmFibGVBdXRvQ29tcGxldGVTdHJpbmcoa2V5KS50b0xvd2VyQ2FzZSgpLmluZGV4T2YodmFsdWUudG9Mb3dlckNhc2UoKSkgPiAtMSkge1xuICAgICAgICAgICAgICAgIG9ialtrZXldID0gdGhpcy5ncm91cC52YWx1ZVtrZXldXG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9pdGVtcyA9IG9iajtcbiAgICAgICAgdGhpcy5FbXB0eVNlYXJjaCh0aGlzLl9pdGVtcywgdmFsdWUpO1xuXG4gICAgICAgIC8vIFVzZXIgaGFzIHR5cGVkIHNvbWV0aGluZyBub3csIHJlc3VsdHMgY291bGQgYmUgc2hvd24uIFdlIG5lZWQgdG8gcmVtb3ZlIHRoZSBcImlzLWluaXRpYWwtZW1wdHlcIiBjbGFzcy5cbiAgICAgICAgdGhpcy5Jc0luaXRpYWxFbXB0eSgpO1xuICAgICAgICB0aGlzLmRyb3Bkb3duLk9wZW4oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIE9uSW5wdXRCbHVycmVkKCkge1xuICAgICAgICBpZiAoIXRoaXMuSGFzQ2hvc2VuVmFsdWUoKSkge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBMZXQgY29tcG9uZW50IGtub3cgY29tcGxldGVyIGlucHV0IGhhcyBiZWVuIGNsZWFyZWQgLVxuICAgICAgICAgICAgICogdGhpcyBmdW5jdGlvbiBzaG93cyB0aGUgbGlzdCBhZ2FpbiwgYWxzbyByZXNldHMgY2hpbGRyZW4sIGlmIGNob3Nlbi5cbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgdGhpcy5Pbk1vZGVsQ2hhbmdlKCcnKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgT25Ib3ZlckRyb3Bkb3duSXRlbShpdGVtOiBBdXRvY29tcGxldGVJdGVtIHwgc3RyaW5nKSB7XG4gICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgdGhpcy5fRE9NLnBsYWNlaG9sZGVyID0gdGhpcy5faXRlbXNbaXRlbV07XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGl0ZW0gPT0gbnVsbCkge1xuICAgICAgICAgICAgdGhpcy5fRE9NLnBsYWNlaG9sZGVyID0gbnVsbDtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX0RPTS5wbGFjZWhvbGRlciA9IGl0ZW07XG4gICAgfVxuXG4gICAgLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0vL1xuICAgIC8vICEgVXRpbHMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy9cbiAgICAvLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PS8vXG5cbiAgICBJc0luaXRpYWxFbXB0eSgpIHtcbiAgICAgICAgaWYgKE9iamVjdC5rZXlzKHRoaXMuX2l0ZW1zKS5sZW5ndGggPT09IDAgJiYgdGhpcy5fY29tcGxldGVyLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5fRE9NLmVtcHR5ID0gdHJ1ZTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX0RPTS5lbXB0eSA9IGZhbHNlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgSGFzQ2hvc2VuVmFsdWUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9ET00uc2VsZWN0ZWQgIT09IG51bGxcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIEVtcHR5U2VhcmNoKG9iajogT2JqZWN0LCBxdWVyeTogc3RyaW5nKSB7XG4gICAgICAgIGlmIChPYmplY3Qua2V5cyhvYmopLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHRoaXMuX0RPTS5ub3RGb3VuZCA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLl9ET00ubm90Rm91bmQgPSB0cnVlO1xuICAgICAgICB0aGlzLm5vUmVzdWx0LmVtaXQoe2dyb3VwOiB7a2V5OiB0aGlzLmdyb3VwLmtleX0sIHF1ZXJ5OiBxdWVyeX0pXG4gICAgfVxuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBDbGVhclZhbHVlKCkge1xuICAgICAgICB0aGlzLl9jb21wbGV0ZXIgPSAnJztcbiAgICAgICAgdGhpcy5fRE9NLnNlbGVjdGVkID0gbnVsbDtcblxuICAgICAgICB0aGlzLmdyb3VwLkluaXRpYWxWYWx1ZSgpO1xuICAgICAgICB0aGlzLklzSW5pdGlhbEVtcHR5KCk7XG4gICAgICAgIC8qKlxuICAgICAgICAgKlxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5zZWxlY3RlZC5lbWl0KHtncm91cDoge2tleTogdGhpcy5ncm91cC5rZXl9LCBpdGVtOiBudWxsfSk7XG4gICAgfVxufVxuIl19